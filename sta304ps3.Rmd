---
title: "Interesting Title"
author: "Matthew Wankiewcz, Xiaoyan Yang, Alen Mitrovski, Harry Hwang"
date: "19/10/2020"
output:
  pdf_document: default
  html_document: default
abstract: The need for higher education is an idea that is constantly growing around
  the world, especially in Canada. In this paper, we run a logistic regression model
  to determine which factors seems to impact someone's chances of only having a high
  school diploma using GSS survey data from 2017. From our model, we find that the
  higher a person's income is, the more likely they are to have completed another
  level of education other than high school. These results are significant as it shows
  that a high school education may not lead to high incomes in Canada.
---

```{r, echo = F, warning=F, message=F}
#install.packages("tidyverse")
#install.packages("gtsummary")
library(tidyverse)
library(gtsummary)
```


```{r, echo = F, warning=F, message=F}
# read in gss 2017 data
gss <- read_csv("inputs/gss.csv")
```


# Introduction

# Data

The dataset we used was from the 2017 GSS survey conducted by the Canadian Government ^[In order to obtain the data, we used the GSS cleaning script from Rohan Alexander and Samantha-Jo Caetano. This file is included in the GitHub repo which supports this analysis and can be found [here](https://github.com/matthewwankiewicz/sta304ps3). GSS files can be accessed by going to www.chass.utoronto.ca, then clicking data centre, signing in, and finding the GSS survey. Then click the desired year (we chose 2017), then click download csv in STATA form, select all variables and download the csv. Then using the gss_cleaning-1.R file in inputs along with gss_dict and gss_labels, run the cleaning script to get your csv.]. According to the Government's website, the objectives of the survey were to gather data on social trends and to provide information on the most important social issues. 

The population for this survey was the total population of Canada but only those who live in the 10 provinces, are not in jail and are 15 years of age or older. The frame of this survey used Stats Canada's phone database and data from the Census in order to find potential candidates for the survey. Lastly, the sample conducted was stratified sampling. The researchers divided the country into different stratas, they required a minimum amount of samples from each area and made sure that the stratas were balanced in order to reflect the country's views properly. 

Respondents were found through the Census because it is conducted on people over the age of 15, it fit right in with their target population. Their initial sample had 43,000 people and brought down the number of invitations sent to 34,000 households while 20,000 responses were expected. The government reported a response rate of 52.4% and with our records, they collected 20602 responses. As for non-response, the researchers changed the weighting on responses in order to account for non-response in order to avoid bias.

```{r, echo=F}
# filtering down what columns we plan to use

gss <- gss %>% 
  mutate(born_canada = ifelse(place_birth_canada == "Born in Canada", 1, 0))

used_cols <- gss %>% select(
  age, age_first_child, age_start_relationship, 
  age_at_first_marriage, age_at_first_birth, feelings_life, sex, place_birth_canada,
  place_birth_macro_region, province, pop_center, marital_status, vis_minority, 
  education, own_rent, living_arrangement, average_hours_worked, self_rated_health,
  self_rated_mental_health, regilion_importance, income_respondent, income_family,
  number_marriages, born_canada, education
)

planned_cols2 <- used_cols %>% select(
  age, feelings_life, sex, province, marital_status, education, own_rent,
  average_hours_worked, self_rated_mental_health, self_rated_health, 
  regilion_importance, income_family, number_marriages, born_canada, education,
  age_at_first_marriage
)

planned_cols3 <- planned_cols2 %>% select(
  feelings_life, sex, income_family, self_rated_mental_health,
  marital_status, age, born_canada, self_rated_health, average_hours_worked, education,
  age_at_first_marriage
)

# create new variable to show if respondent only has a high school education
gss2 <- gss %>% 
  mutate(only_highschool = ifelse(grepl("high school", education, ignore.case = T), 1, 0),
         minority = ifelse(vis_minority == "Not a visible minority", 1, 0))

# create new variable to show if respondent owns or rents
gss2 <- gss2 %>% 
  mutate(rent = ifelse(own_rent == "Rented, even if no cash rent is paid", 1, 0))

gss2 <- gss2 %>% 
  mutate(married = ifelse(marital_status == "Married", 1, 0)) %>% 
  filter(age >= 23)

gss3 <- gss2 %>% 
  mutate(age_groups = cut(age,
    breaks = c(0, 30, 40, 50, 60, 70, Inf),
    labels = c("15-29", "30-39", "40-49", "50-59", "60-69", "70+")
  ))

planned_cols3 <- planned_cols3 %>% 
  mutate(level_of_ed = ifelse(grepl("high school", education, ignore.case = T), 1, 0)) 
```

```{r, echo = F, message=F, warning=F}

# bar plot for income
gss2 %>% ggplot(aes(income_respondent, fill = income_respondent)) + 
  geom_bar() +
  labs(title = "Figure 1: Distribution of Income Groups",
       x = "Income", y = "Count",
       caption = "Source: GSS 2017 Survey Data") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 50, hjust = 1, size = 7))

# bar plot for education level (not binary)
gss2 %>% ggplot(aes(education)) + 
  geom_bar() +
  labs(title = "Figure 2: Distribution of Educations",
       x = "Education Level", y = "Count",
       caption = "Source: GSS 2017 Survey Data") +
  coord_flip() +
  theme_minimal() +
  theme(axis.text.y = element_text(size = 7))

# bar plot showing age groups
gss3 %>% ggplot(aes(age_groups, fill = age_groups)) + 
  geom_bar() +
  labs(title = "Figure 3: Distribution of Age Groups",
       x = "Age Group", y = "Count",
       caption = "Source: Simulated Data") +
  theme_minimal()
```

Figures 1, 2, and 3 show the distribution of income, education level, and age, respectively.

From our plots we can see some strengths and weaknesses of the survey. We can see that the distribution of age is fairly even which allows us to get a good idea of the opinions of all age ranges. Another strength is that the distribution of education levels seems to be accurate, we see that fewer people tend to get Bachelor's degrees compared to high school diplomas, which bodes well for our intended model, we need a fairly even distribution to get a good model. 

As for our weaknesses, we see that many respondents had incomes under 50000 dollars, which could represent people that are retired or younger people who are in school and don't work as much. Also, some questions are subjective in this survey, such as self rating your health and mental health or your feelings on life. This is tough to interpret because one person's idea of good health could be someones definition of poor health which can cause some issues with interpretations. 

For our model, we used the variables: number of children, sex, respondent income, whether the respondent is married not, whether the respondent was born in Canada and lastly we made a new variable which is binary and gives a 1 if the respondent has only completed high school or equivalent and 0 otherwise.

# Model

We plan to run a logistic regression model in the form:

$$log \left( \frac{\hat{p}}{1-\hat{p}} \right) = \beta_1 + \beta_2*x_{children} + \beta_3*x_{male} + \beta_4*x_{income > 125000} + \beta_5*x_{income_{25000-49999}} + \\ \beta_6*x_{income_{50000 - 74999}} + \beta_7*x_{income_{75000-99999}} + \beta_8*x_{income_{< 25000}} + \beta_9*x_{marraige} + \beta_{10}*x_{canada}$$
where each $\beta$ represents a coefficient determined by our model and is multiplied by each variable we planned to include. For some variables such as income, we see x values for each level. This happens because our model will expect a 1 or 0 for each of the entries, so if someone has an income under 25000 dollars, that $\beta$ will be 1 and the others for income will be 0. Also, the $\beta$ for number of children is just multiplied by how many children the person has, it does not use binary values like the other coefficients. $\hat{p}$ represent the probability a respondent has completed high school and $log$ represents the natural logarithm.

The value we want to predict is whether or not someone has had a higher education, more specifically, we restrict it to a variable which gives a 1 for if a person has only completed high school and a 0 if they've completed some other level of education.

This model was run using the glm. The glm function was run with the family being specified as binomial() because our response variable "only_highschool" is a binary variable with responses of "yes" or "no".

The ouput of our model gives us a probability of whether someone has only completed high school. We find this by assigning each $\beta$ value a 1 or 0 (or number for number of children) and then solve it using the equation: $$\hat{p} = \frac{e^{sum}}{1 + e^{sum}}$$. 

Where e is the exponential function and sum is the sum of our model's equation.

```{r, echo=F, message=F, warning=F}
# run model with high school education as response, # of children, gender,
# income, rent/own home and marriage status being explanatory

gss_logit <- glm(only_highschool ~ total_children +
                   sex + income_respondent + born_canada + married,
                 data = gss2, family = binomial())
```

# Results

Figure 4
```{r, echo=F, message=F, warning=F}
# visualize the model
#summary(gss_logit)
logit_summary <- broom::tidy(gss_logit, conf.int = T)
logit_summary
```

Using the glm() function, we find that our logit function is:

$$log \left( \frac{\hat{p}}{1-\hat{p}} \right) = -2.87 + .24*x_{children}
+ .44*x_{male} +-.11*x_{income > 125000} + 1.49*x_{income_{25000-49999}} + \\ .76*x_{income_{50000 - 74999}} + .25*x_{income_{75000-99999}} + 1.98*x_{income_{< 25000}} - .34*x_{marraige} + .62*x_{canada}$$

The output of this model is not like other regressions where we plug in numbers and receive our value right away, we have to do a little more work for this one. Every term in this equation will either be multiplied by 1 or 0, if the person has that characteristic or not. You may notice that some categories are missing, such as the female gender, income from 100000-124999 dollars and not born in Canada. These are missing becuase the function takes the other values as default ideal values, so for every difference in the category, the probability of having only a high school diploma, is different relative to the baseline values. 


```{r, echo=F, warning=F, message=F}
# get summary and plot coefficients
logit_summary %>% ggplot(aes(term, estimate)) + geom_point() + 
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high),
                width = .5, colour = "black") +
  geom_hline(aes(yintercept = 0), color = "black", linetype = "dashed") +
  coord_flip() + 
  labs(title = "Figure 5: Distribution of Estimation of Coefficients",
       subtitle = "Bars represent estimated error",
       y = "Weight",
       x = "Estimate",
       caption = "Source: GSS 2017 Data") +
  theme_classic()
```

This graph shows the distribution of coefficients for each variable covered, with the standard error extended to the left and right. There is a bar in the middle of the graph (at x = 0), to help visualize whether the variable has increases the probability of a person only completing high school.

Figure 6
```{r, echo=F, warning=F, message=F}
# plot more detailed regression table, including Odds Ratios and p-values for 
# odds ratios
gtsummary::tbl_regression(gss_logit, intercept = T)
```

This is another way of looking at our coefficients, we can find odd ratios of each category impacting whether or not someone has only completed high school. The way we intepret these odd ratios are through the decimal points of the ratios. If one outcome is n decimal places higher, the odds of it impacting the model's decision are n times more likely. For example, we see that the odds ratio for Males is 0.45, which means that males are 45% more likely to have only completed high school. The same idea applies for negative values, it means they are less likely to impact. 

We can also look at the p-values, to see which results are the most statistically significant. P-values are used with null hypotheses to determine if an experiment is significant. Since our p-values are under the traditional benchmark of 0.05, we can reject our null-hypothesis and conclude that these results are in-fact, significant.

# Discussion

## Analysis

Now that we've created our model and plotted it, it's time to interpret what it means and how it impacts the small and large worlds. Firstly, we should interpret our coefficients and how they determine a person's education level. When looking at our p-values for the coefficients, we find that almost all coefficients are very strong evidence to reject our null hypothesis as discussed after figure 6. We see that having an income level of over 125000 dollars still gives evidence to reject our null hypothesis (that it has no impact on education level) but it's very close to not being enough evidence. What this means is that although it does decrease your chances of only having a high school diploma, there may have been instances where a person reaches that income level with a high school diploma. This makes sense because in the past people did not need university degrees in order to make a successful living, because most people didn't go to university. According to an article in the UK Guardian called "Student Experience - Then and Now", "In the early 1960s, only 4% of school leavers went to university, rising to around 14% by the end of the 1970s. Nowadays, more than 40% of young people start undergraduate degrees" (Lightfoot 2016). This is a significant increase in levels and can help explain the higher than normal p-value for our model's standards.

Now that we've explained our p-values, we can take a look at which coefficients help lead to the largest increase in odds of only having a high school diploma. In order to do this most accurately, it's best to do this category by category as the ratios are relative to their categories. First, we can look at the number of children a person has and we see that for every child a person has their odds of only completing a high school diploma decreases by 1.6 times ##CONFIRM##. This result makes sense majority of the younger respondents likely have only completed high school and don't have any kids. It's more common for some to go to university and have a full time job to have more kids than a high schooler. Next we can move on to gender and we find a coefficient of 0.54, it implies that men are more likely to have only completed high school compared to women. This makes sense because men may be more likely to pick up trades and work directly after high school and although women are picking up trades more often, the data is still suggesting men are more likely to take other routes after high school.

Next we can look at income, which seems to be a fairly strong predictor of a person's education level. Our benchmark value for this category was an income level of 100000 - 124999 dollars. We can see that people with incomes lower than 50000 are much more likely to have only completed high school, income levels under 25000 have odds 110% higher than those of 100000 - 124999 dollars and the level of 25000 - 49999 has odds about 40% higher than the benchmark. These are very significant results because we now have a clear view of how income predicts level of education. This is also shown at the other extreme, with income over 125000, we see that people are 1.14 times less likely to have only completed high school. 

BORN IN CANADA + MARRAIGE EXPLANATION HERE

When applying our results to the small and large world we find that we would likely yield different results. Applying our model to the small world, in this case keeping it restricted to the people of Canada, we would find that our model would hold up quite well. The model gives fairly good probabilities at whether a person gets an education higher than high school for the people of Canada which makes sense because for the most part, people tend to want to go to university or college or are encouraged by their family to go there. This is not the case for people in other countries. In other countries, people may want to apply their work somewhere else or can't afford university so they instead find different work after high school. This is where our model may fail in the large world because of the different levels of university enrollment compared to Canada.


## Weaknesses and Next Steps

Although our model seems to be fairly accurate when modelling the population of Canada we still have to address some weaknesses that hindered the strength of our model. Firstly, the variable representing if someone completed high school only picks up if someone completed high school or not, implying that it may have been picking up people that didn't even complete high school. This causes some issues because it could skew some coefficients of our model and it turn makes our model weaker . Lastly, we can also identify weaknesses with the data itself and how it impacts our model. When looking at the income variable, it is grouped into fairly large intervals and we feel that it may be more accurate if they asked for respondent's income without categorizing it. Since it is categorized, it can let people that have no income be equal to people with incomes of 24000 or people with very large incomes over 150000 be equal with those who make 125000. This hurts the accuracy of our model because the coefficient found could be a numerical relationship as opposed to a categorical one, meaning that the relationship between the variables would likely be stronger, leading to more accurate results. 

Along with the weaknesses, we did find ways to improve our method in the future or perhaps different studies we can look at using our model. Firstly, in the future we could attempt to weight each response differently in order to account for the large proportion of people born outside of Canada who have higher educations. In the data we find that a higher proportion of people not born in Canada go on to higher education, compared to those born in Canada. In future studies we could try to weight the repsonses differently in order to make these proportions equal in order to strengthen our model and make it even more applicable to the people of Canada. 

# Appendicies

## Citations

- R Core Team (2019). R: A language and environment for statistical computing. R Foundation for
  Statistical Computing, Vienna, Austria. URL https://www.R-project.org/.
  
- JJ Allaire and Yihui Xie and Jonathan McPherson and Javier Luraschi and Kevin Ushey and Aron
  Atkins and Hadley Wickham and Joe Cheng and Winston Chang and Richard Iannone (2020).
  rmarkdown: Dynamic Documents for R. R package version 2.3. URL https://rmarkdown.rstudio.com.

- Wickham et al., (2019). Welcome to the tidyverse. Journal of Open Source Software, 4(43),
  1686, https://doi.org/10.21105/joss.01686
  
- Rohan Alexander and Sam Caetano (2020). Cleaning the GSS 2017 file. gss_cleaning-1.R

- Yihui Xie (2020). knitr: A General-Purpose Package for Dynamic Report Generation in R. R
  package version 1.28.
  
- Daniel D. Sjoberg, Michael Curry, Margie Hannum, Karissa Whiting and Emily C. Zabor (2020).
  gtsummary: Presentation-Ready Data Summary and Analytic Result Tables. R package version
  1.3.5. https://CRAN.R-project.org/package=gtsummary
  
- Liz Lightfoot. The student experience â€” then and now. The Guardian. 
  from https://www.theguardian.com/education/2016/jun/24/has-university-life-changed-student-experience-past-present-parents-vox-pops

- Stats Canada, General Social Survey 
  (2017), https://www23.statcan.gc.ca/imdb/p2SV.pl?Function=getSurvey&SDDS=4501
  
## Additional Plots

Below are some additional plots which couldn't make it into the analysis.

```{r, echo=FALSE, warning=FALSE}
percent <- function(x, digits = 0, format = "f", ...) {      
  paste0(formatC(x * 100, format = format, digits = digits, ...), "%")
}

# visual minority
temp <- gss %>% filter(!is.na(vis_minority)) %>% group_by(vis_minority) %>% summarise(n=n())
v_m <- temp %>% mutate(prop=n/sum(n))
v_m %>%
ggplot(aes(x = vis_minority, y = prop, fill = vis_minority)) +
    geom_bar(stat = "identity") +
    theme_classic() +
    labs(
        x = "Visual Minority",
        y = "Percentage",
        title = paste(
            "Visual Minority Summary"
        )
    )

# born in canada
# sprintf(x, fmt = '%#.3f')  
temp1 <- gss2 %>% filter(!is.na(born_canada)) %>% group_by(born_canada) %>% summarise(n=n())
b_c <- temp1 %>% mutate(prop=n/sum(n))
b_c <- b_c %>% mutate(born_in_canada = ifelse(born_canada==0, "Not Born in Canada", "Born in Canada"))
percentage <- percent(b_c$prop)
b_c <- cbind(b_c, percentage)
b_c %>%
ggplot(aes(x = born_in_canada, y = percentage, fill = born_canada)) +
    geom_bar(stat = "identity") +
    theme_classic() +
    labs(
        x = "Born in Canada",
        y = "Percentage",
        title = paste(
            "Born in Canada Summary"
        )
    )


# sex
temp2 <- gss %>% filter(!is.na(sex)) %>% group_by(sex) %>% summarise(n=n())
sex <- temp2 %>% mutate(prop=n/sum(n))

percentage <- percent(sex$prop)
sex <- cbind(sex, percentage)
sex %>%
ggplot(aes(x = sex, y = percentage, fill = sex)) +
    geom_bar(stat = "identity") +
    theme_classic() +
    labs(
        x = "Gender",
        y = "Percentage",
        title = paste(
            "Gender Summary"
        )
    )


# provinces
temp3 <- gss %>% filter(!is.na(province)) %>% group_by(province) %>% summarise(n=n())
province <- temp3 %>% mutate(prop=n/sum(n))
percentage <- province$n/sum(province$n) * 100
#percentage <- percent(province$prop)
province <- cbind(province, percentage)
province %>%
ggplot(aes(x = province, y = percentage, fill = province)) +
    geom_bar(stat = "identity") +
    theme_classic() +
    labs(
        x = "Provinces",
        y = "Percentage",
        title = paste(
            "Population by Provinces"
        )
    ) +  coord_flip()

# income
temp4 <- gss %>% filter(!is.na(income_respondent)) %>% group_by(income_respondent) %>% summarise(n=n())
inc_resp <- temp4 %>% mutate(prop=n/sum(n))
percentage <- inc_resp$n/sum(inc_resp$n) * 100
#percentage1 <- percent(inc_resp$prop)
#percentage <-as.numeric(percentage1)
inc_resp <- cbind(inc_resp, percentage)

inc_resp %>% ggplot(aes(x = income_respondent, y = percentage, fill = income_respondent)) +
    geom_bar(stat = "identity") +
    theme_classic() +
    labs(
        x = "Inome Category",
        y = "Percentage",
        title = paste(
            "Income Category Summary"
        )
    ) +  coord_flip()
```

